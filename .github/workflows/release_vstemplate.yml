name: Zip and Release Visual Studio template

on:
  push:
    branches:
      - 'main'

jobs:
  zip:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Git repository
      uses: actions/checkout@v4
      with:
        path: ./template
    - name: Create output folder
      run: mkdir -p ./output
    - name: Store commit
      run: pushd ./template && git rev-parse --short HEAD > ../output/commit.txt && popd
    - name: Convert to Visual Studio template
      run: |
        cat << EOF > ./template/HasteSteamWorkshopMod.vstemplate
        <VSTemplate Version="3.0.0" xmlns="http://schemas.microsoft.com/developer/vstemplate/2005" Type="Project">
          <TemplateData>
            <Name>Haste Steam Workshop Mod</Name>
            <ProjectType>CSharp</ProjectType>
            <ProjectSubType>
            </ProjectSubType>
            <SortOrder>1000</SortOrder>
            <CreateNewFolder>true</CreateNewFolder>
            <DefaultName>Haste Steam Workshop Mod</DefaultName>
            <ProvideDefaultName>true</ProvideDefaultName>
            <LocationField>Enabled</LocationField>
            <EnableLocationBrowseButton>true</EnableLocationBrowseButton>
            <CreateInPlace>true</CreateInPlace>
          </TemplateData>
          <TemplateContent>
            <Project TargetFileName="Haste$projectname$Mod.csproj" File="HasteExampleMod.csproj" ReplaceParameters="true">
              <ProjectItem ReplaceParameters="true" TargetFileName=".gitignore">.gitignore</ProjectItem>
              <ProjectItem ReplaceParameters="false" TargetFileName=".steam.props">.steam.props</ProjectItem>
              <ProjectItem ReplaceParameters="true" TargetFileName="$projectname$.cs">Example.cs</ProjectItem>
              <ProjectItem ReplaceParameters="false" TargetFileName="LICENSE">LICENSE</ProjectItem>
            </Project>
          </TemplateContent>
        </VSTemplate>
        EOF

        rm -fr ./template/.git
        rm -fr ./template/.github
    - name: Zip template
      run: zip -r ./output/HasteSteamWorkshopMod.zip ./template/*
    - name: Archive zip artifact
      uses: actions/upload-artifact@v4
      with:
        name: zipped-vstemplate
        path: ./output
  release:
    runs-on: ubuntu-latest
    needs: [ zip ]
    permissions:
      contents: write
    steps:
      - name: Download zip artifact
        uses: actions/download-artifact@v4
        with:
          name: zipped-vstemplate
          path: vstemplate
      - name: Create draft release and upload template zip
        uses: actions/github-script@v7
        with:
          script: |
            const path = require('node:path');
            const fs = require('node:fs/promises');

            const commit = await fs.readFile('vstemplate/commit.txt', 'utf-8').trim();

            const release = await github.rest.repos.createRelease({
              ... context.repo,
              name: `Visual Studio Template (commit ${ commit })`,
              draft: true,
              tag_name: `${{ github.ref_name }}-${ commit }`,
              generate_release_notes: true
            });

            console.log('Draft release created:', release.data.html_url);

            const data = await fs.readFile('vstemplate/HasteSteamWorkshopTemplate.zip');
            await github.rest.repos.uploadReleaseAsset({
              ... context.repo,
              release_id: release.data.id,
              name: 'HasteSteamWorkshopTemplate.zip',
              data
            });

            console.log(`Template zip asset uploaded to draft release`);
